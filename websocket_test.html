<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
</head>
<body>
    <h1>WebSocket Test</h1>
    <div id="log"></div>
    <button onclick="sendTestCommand('play')">Test Play Command</button>
    <button onclick="sendTestCommand('pause')">Test Pause Command</button>
    <button onclick="sendTestCommand('seek', 60)">Test Seek Command</button>

    <script>
        const log = document.getElementById('log');
        
        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        addLog('ðŸŸ¡ [Test] Connecting to WebSocket server at ws://localhost:8765');

        const ws = new WebSocket('ws://localhost:8765');

        ws.onopen = () => {
            addLog('ðŸŸ¢ [Test] âœ… Connected to WebSocket server', 'success');
            
            // Send a test track message
            const trackMessage = {
                message_type: 'TRACK_DETECTED',
                data: {
                    title: 'Test Song',
                    artist: 'Test Artist',
                    thumbnail: null,
                    source: 'test',
                    url: 'test://url',
                    timestamp: Date.now(),
                    is_playing: true,
                    currentTime: 0,
                    duration: 180
                },
                timestamp: Date.now()
            };
            
            addLog('ðŸŸ¡ [Test] Sending track message: ' + JSON.stringify(trackMessage));
            ws.send(JSON.stringify(trackMessage));
            
            // Send periodic pings
            setInterval(() => {
                if (ws.readyState === WebSocket.OPEN) {
                    const pingMessage = {
                        message_type: 'ping',
                        data: {},
                        timestamp: Date.now()
                    };
                    addLog('ðŸŸ¡ [Test] Sending ping');
                    ws.send(JSON.stringify(pingMessage));
                }
            }, 30000);
        };

        ws.onmessage = (event) => {
            try {
                const message = JSON.parse(event.data);
                addLog('ðŸŸ¢ [Test] Received message: ' + JSON.stringify(message), 'success');
                
                if (message.message_type === 'PLAYBACK_COMMAND') {
                    addLog('ðŸŸ¢ [Test] âœ… RECEIVED PLAYBACK COMMAND: ' + JSON.stringify(message.data), 'success');
                    addLog('ðŸŸ¢ [Test] Command: ' + message.data.command, 'success');
                    addLog('ðŸŸ¢ [Test] SeekTime: ' + message.data.seekTime, 'success');
                }
            } catch (error) {
                addLog('âŒ [Test] Failed to parse message: ' + error.message, 'error');
                addLog('Raw message: ' + event.data, 'error');
            }
        };

        ws.onerror = (error) => {
            addLog('âŒ [Test] WebSocket error: ' + error.message, 'error');
        };

        ws.onclose = (event) => {
            addLog('ðŸ”´ [Test] WebSocket closed: ' + event.code + ' ' + event.reason, 'error');
        };

        // Function to send test commands from buttons
        function sendTestCommand(command, seekTime = null) {
            if (ws.readyState === WebSocket.OPEN) {
                addLog('ðŸŸ¡ [Test] Sending test command: ' + command + (seekTime ? ' (seek to ' + seekTime + 's)' : ''));
                // This simulates what the desktop app should send
                // We won't actually send it since we're testing the other direction
                addLog('ðŸŸ¡ [Test] (In real scenario, desktop app would send this command to us)');
            } else {
                addLog('âŒ [Test] WebSocket not connected', 'error');
            }
        }

        // Keep connection alive status
        setInterval(() => {
            const states = ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'];
            addLog('ðŸ”µ [Test] WebSocket state: ' + states[ws.readyState]);
        }, 60000);
    </script>
</body>
</html>